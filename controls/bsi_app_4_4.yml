# In BSI Basic Protection are multiple Requirements in one control.
# i.e. there are multiple sentences, some including a RFC2119 keyword
# Since we must increase granularity to create a precise control,
# we number each sentence with a RFC2119 keyword as a section, grouping sentences, which are logically connected.
# we number inline in brackets, so the lookup is easy
# we reference these numbers in comments over each rule or group of rules
policy: 'BSI-APP-4-4'
title: 'BSI APP.4.4 Kubernetes'
id: bsi_app_4_4
version: '1.0'
source: https://www.bsi.bund.de/SharedDocs/Downloads/EN/BSI/Grundschutz/International/bsi_it_gs_comp_2022.pdf
levels:
  - id: basic
  - id: standard
    inherits_from:
    - basic
  - id: elevated
    inherits_from:
    - standard

controls:
  - id: APP.4.4.A1
    title: Planning the Separation of the Applications
    levels:
    - basic
    description: >-
      Before going live, the manner in which the applications running in the pods in question and
      their different test and production operating environments will be separated MUST be
      planned. Based on the protection needs of the applications, the planning MUST determine
      which architecture of namespaces, meta tags, clusters, and networks adequately addresses the
      risks at hand and whether virtualised servers and networks should also be used.
      The planning MUST include provisions separating for networks, CPUs, and persistent
      volumes. The separation SHOULD also take into account and be aligned with the network
      zone concept and the protection requirements at hand.
      Each application SHOULD run in a separate Kubernetes namespace that includes all the
      programs of the application. Only applications with similar protection needs and similar
      possible attack vectors SHOULD share a Kubernetes cluster.
    notes: >-
      TBD
    status: pending
    rules: []

  - id: APP.4.4.A2
    title: Planning Automation with CI/CD
    levels:
    - basic
    description: >-
      Automating the operation of applications in Kubernetes using CI/CD MUST ONLY take place
      after appropriate planning. The planning MUST cover the entire lifecycle from commissioning
      to decommissioning, including development, testing, operation, monitoring, and updates. A
      roles and rights concept and the securing of Kubernetes Secrets MUST be part of the planning
    notes: >-
      TBD
    status: pending
    rules: []

  - id: APP.4.4.A3
    title: Identity and Access Management for Kubernetes
    levels:
    - basic
    description: >-
      Kubernetes and all other control plane applications MUST authenticate and authorise each
      action taken by a user or, in automated mode, corresponding software. This applies whether
      the actions are taken via a client, a web interface, or a corresponding API. Administrative
      actions MUST NOT be performed anonymously.
      Each user MUST ONLY be granted the permissions they absolutely require. Unlimited access
      rights MUST be granted in a very restrictive manner.
      Only a small group of people SHOULD be authorised to define automation processes. Only
      selected administrators SHOULD be given the right to create or change shares for persistent
      volumes in Kubernetes.
    notes: >-
      TBD
    status: pending
    rules:
      - api_server_anonymous_auth
      - kubelet_anonymous_auth
      - kubeadmin_removed
      - rbac_least_privilege

  - id: APP.4.4.A4
    title: Separation of Pods
    levels:
    - basic
    description: >-
      (1) The operating system kernel of nodes MUST have isolation mechanisms to restrict visibility
      and resource usage among the corresponding pods (cf. Linux namespaces and cgroups). (2) At
      minimum, this isolation MUST include process IDs, inter-process communication, user IDs,
      the file system, and the network (including the hostname).
    notes: >-
      Since these are OS based requirements, they are included in the rhcos4 bsi profile.
      One of the key mechanisms in OCP4 to separate Workloads is SELinux. Thus this should be
      enforced. Furthermore a admin should check the SCCs as they might lift some of the separations
      between workloads and/or hosts.
    status: inherently met
    rules:
      # Section 1
      - coreos_enable_selinux_kernel_argument
      - selinux_policytype
      - selinux_state
      # Section 2
      - scc_limit_privileged_containers
      - scc_limit_root_containers
      # inter process communication
      - scc_limit_ipc_namespace
      # process IDs
      - scc_limit_process_id_namespace
      # file system
      - scc_limit_host_dir_volume_plugin
      # network
      - scc_limit_net_raw_capability
      - scc_limit_network_namespace

  - id: APP.4.4.A5
    title: Backup in the Cluster
    levels:
    - basic
    description: >-
      A cluster MUST have a backup. The backup MUST include:
        • Persistent volumes
        • Configuration files for Kubernetes and the other programs of the control plane
        • The current state of the Kubernetes cluster, including extensions
        • Databases of the configuration (namely etcd in this case)
        • All infrastructure applications required to operate the cluster and the services within it
        • The data storage of the code and image registries
        Snapshots for the operation of the applications SHOULD also be considered. Snapshots MUST
        NOT be considered a substitute for backups.
    notes: >-
      TBD
    status: pending
    rules: []

  - id: APP.4.4.A6
    title: Initialisation of Pods
    levels:
    - standard
    description: >-
      If an initialisation (e.g. of an application) takes place in a pod at start-up, this SHOULD take
      place in a separate Init container. It SHOULD be ensured that the initialisation terminates all
      processes that are already running. Kubernetes SHOULD ONLY start the other containers if
      the initialisation is successful.
    notes: >-
      TBD
    status: pending
    rules: []

  - id: APP.4.4.A7
    title: Separation of Networks for Kubernetes
    levels:
    - standard
    description: >-
      Networks for the administration of nodes, the control plane, and the individual networks of
      application services SHOULD be separated.
      Only the network ports of the pods necessary for operation SHOULD be released into the
      designated networks. If a Kubernetes cluster contains multiple applications, all the network
      connections between the Kubernetes namespaces SHOULD first be prohibited and only
      required network connections permitted (whitelisting). The network ports necessary for the
      administration of the nodes, the runtime, and Kubernetes (including its extensions) SHOULD
      ONLY be accessible from the corresponding administration network and from pods that need
      them.
      Only selected administrators SHOULD be authorised in Kubernetes to manage the CNI and
      create or change rules for the network.
    notes: >-
      TBD
    status: pending
    rules: []

  - id: APP.4.4.A8
    title: Securing Configuration Files on Kubernetes
    levels:
    - standard
    description: >-
      The configuration files of a Kubernetes cluster, including all its extensions and applications,
      SHOULD be versioned and annotated.
      Access rights to configuration file management software SHOULD be granted in a restrictive
      manner. Read and write access rights to the configuration files of the control plane SHOULD
      be assigned and restricted with particular care.
    notes: >-
      TBD
    status: pending
    rules: []

  - id: APP.4.4.A9
    title: Use of Kubernetes Service Accounts
    levels:
    - standard
    description: >-
      Pods SHOULD NOT use the "default" service account. Rights SHOULD NOT be granted to the
      "default" service account. Pods for different applications SHOULD run under their own service
      accounts. Access rights for the service accounts of the applications' pods SHOULD be limited
      to those that are strictly necessary.
      Pods that do not require a service account SHOULD not be able to view it or have access to
      corresponding tokens.
      Only control plane pods and pods that absolutely need them SHOULD use privileged service
      accounts.
      Automation programs SHOULD each receive their own tokens, even if they share a common
      service account due to similar tasks.
    notes: >-
      TBD
    status: pending
    rules: []

  - id: APP.4.4.A10
    title: Securing Automation Processes
    levels:
    - standard
    description: >-
      All automation software processes, such as CI/CD and their pipelines, SHOULD only operate
      with the rights that are strictly necessary. If different user groups can change configurations or
      start pods via automation software, this SHOULD be done for each group through separate
      processes that only have the rights necessary for the respective user group.
    notes: >-
      This control needs to be adressed on an organizational level. All service accounts used by 
      automation software need to adhere to the principle of least privilege.
    status: not applicable
    rules: []

  - id: APP.4.4.A11
    title: Container Monitoring
    levels:
    - standard
    description: >-
      In pods, each container SHOULD define a health check for start-up and operation ("readiness"
      and "liveness"). These checks SHOULD provide information about the availability of the
      software running in a pod. The checks SHOULD fail if the monitored software cannot perform
      its tasks properly. For each of these checks, a time period SHOULD be defined that is
      appropriate for the service running in the pod. Based on these checks, Kubernetes SHOULD
      delete or restart the pods.
    notes: >-
      TBD
    status: pending
    rules: []

  - id: APP.4.4.A12
    title: Securing Infrastructure Applications
    levels:
    - standard
    description: >-
      If a separate registry for images or automation software, persistent volume management,
      configuration file storage, or similar is in use, its protection SHOULD at least consider:
        • Use of personal and service accounts for access
        • Encrypted communication on all network ports
        • Restrictive assignment of permissions to user and service accounts
        • Logging of changes
        • Regular data backups.
    notes: >-
      This requirement needs to be adressed in the respective separate systems.
      However, one requirement (Encrypted communication on all network ports) can partitially be
      checked by ensuring that no registry is allowed in over insecure protocols
    status: partial
    rules:
      - ocp_insecure_registries
      - ocp_insecure_allowed_registries_for_import

  - id: APP.4.4.A13
    title: Automated Configuration Auditing
    levels:
    - elevated
    description: >-
      There SHOULD be an automated audit that checks the settings of nodes, of Kubernetes, and of
      the pods of applications against a defined list of allowed settings and standardised
      benchmarks.
      Kubernetes SHOULD enforce these established rules in each cluster by connecting appropriate
      tools.
    notes: >-
      TBD
    status: pending
    rules: []

  - id: APP.4.4.A14
    title: Use of Dedicated Nodes
    levels:
    - elevated
    description: >-
      In a Kubernetes cluster, nodes SHOULD be assigned dedicated tasks and only run pods that are
      assigned to each task.
      Bastion nodes SHOULD handle all incoming and outgoing data connections of between
      applications and other networks.
      Management nodes SHOULD operate control plane pods and only handle control plane data
      connections.
      If deployed, storage nodes SHOULD only operate the fixed persistent volume services pods in
      a cluster.
    notes: >-
      TBD
    status: pending
    rules: []

  - id: APP.4.4.A15
    title: Separation of Applications at Node and Cluster Level
    levels:
    - elevated
    description: >-
      Applications with very high protection needs SHOULD each use their own Kubernetes clusters
      or dedicated nodes that are not available for other applications
    notes: >-
      TBD
    status: pending
    rules: []

  - id: APP.4.4.A16
    title: Use of Operators
    levels:
    - elevated
    description: >-
      The automation of operational tasks in operators SHOULD be used for particularly critical
      applications and control plane programs.
    notes: >-
      TBD
    status: pending
    rules: []

  - id: APP.4.4.A17
    title: Attestation of Nodes
    levels:
    - elevated
    description: >-
      (1) Nodes SHOULD send a cryptographically secured (and, if possible, TPM-verified) status
      message to the control plane. (2) The control plane SHOULD ONLY accept nodes into a cluster
      that have successfully proven their integrity.
    notes: >-
      OpenShift Nodes are using Red Hat CoreOS (RHCOS) by default, an immutable operating system. 
      While RHEL is also supported for Compute Nodes, RHCOS is mandatory for Control Plane Nodes and 
      recommended for all nodes. The correct version and configuration of RHCOS is verified 
      cryptographically with the desired state, that is managed by the Control Plane using MachineConfigs. 
      Any manual change on managed files is overwritten to ensure the desired state. Therefore, the 
      control is mostly inheretly met when using CoreOS for all nodes.
      
      Section 1: OpenShift uses an internal Certificate Authority (CA). The nodes (kubelet to API server
      and MachineConfig daemon to MachineConfi server) are communicating using node-specific certificates,
      signed by this CA. Correct permissions of relevant files and secure TLS configuration are verified
      using the referenced rules.

      Section 2: Using the Red Hat File Integrity Operator, all files on the RHCOS nodes can be
      cryptographically checked for integrity using Advanced Intrusion Detection Environment (AIDE).
    status: automated
    rules:
      # Section 1 (worker / kubelet)
      - file_groupowner_kubelet_conf
      - file_groupowner_worker_ca
      - file_groupowner_worker_kubeconfig
      - file_groupowner_worker_service
      - file_owner_kubelet
      - file_owner_kubelet_conf
      - file_owner_worker_ca
      - file_owner_worker_kubeconfig
      - file_owner_worker_service
      - file_permissions_kubelet
      - file_permissions_kubelet_conf
      - file_permissions_worker_ca
      - file_permissions_worker_kubeconfig
      - file_permissions_worker_service
      - kubelet_configure_client_ca
      - kubelet_configure_tls_cert
      - kubelet_configure_tls_cipher_suites
      - kubelet_configure_tls_key
      - kubelet_configure_tls_min_version
      # Section 1 (API Server)
      - api_server_client_ca
      - api_server_kubelet_client_cert
      - api_server_kubelet_client_key
      - api_server_https_for_kubelet_conn
      - api_server_tls_cert
      - api_server_tls_cipher_suites
      - api_server_tls_private_key
      - api_server_tls_security_profile_not_old
      - tls_version_check_apiserver
      # Section 2
      - cluster_version_operator_exists
      - cluster_version_operator_verify_integrity
      - file_integrity_exists
      - file_integrity_notification_enabled

  - id: APP.4.4.A18
    title: Use of Micro-Segmentation
    levels:
    - elevated
    description: >-
      (1) Pods SHOULD ONLY be able to communicate with each other through the necessary network
      ports, even within a Kubernetes namespace. (2) There SHOULD be rules within the CNI that
      disallow all but the necessary network connections within the Kubernetes namespace. (3) These
      rules SHOULD precisely define the source and destination of the allowed connections using at
      least one of the following criteria: service name, metadata (“labels”), Kubernetes service
      accounts, or certificate-based authentication.
      (4) All the criteria used as labels for a connection SHOULD be secured in such a way that they 
      can only be changed by authorised persons and management services.
    notes: >-
      In a cluster using a network plugin that supports Kubernetes network policy, network isolation 
      is controlled entirely by NetworkPolicy objects. In OpenShift, the default plugins (OpenShift SDN,
      OVN Kubernetes) supports using network policy. Support for NetworkPolicy objects is verified
      using rules.

      Section 1-3: By default, all pods in a project are accessible from other pods and network endpoints. 
      To isolate one or more pods in a project, you need to create NetworkPolicy objects in that project
      to indicate the allowed incoming connections. If a pod is matched by selectors in one or more 
      NetworkPolicy objects, then the pod will accept only connections that are allowed by at least 
      one of those NetworkPolicy objects. A pod that is not selected by any NetworkPolicy objects 
      is fully accessible. 
      
      It is useful to create default policies for each application namespace e.g. to deny all ingress
      traffic by default. The existance of at least one network policy and the automatic creation
      as part of a namespace template is checked using rules. The creation of suitable NetworkPolicy
      objects that satisfy the requirements from sections 1 to 3, however, needs to be ensured by the
      application owner.
      
      Section 4: It needs to be ensured organizationally, that only required subjects are granted
      RBAC to change the relevant Kubernetes objects.
    status: partial
    rules:
      # General support of network policies
      - configure_network_policies
      # Section 1-2
      - configure_network_policies_namespaces
      - project_config_and_template_network_policy

  - id: APP.4.4.A19
    title: High Availability of Kubernetes
    levels:
    - elevated
    description: >-
      A Kubernetes operation SHOULD be set up in such a way that if a site fails, the clusters (and
      thus the applications in the pods) either continue to run without interruption or can be
      restarted in a short time at another site.
      Should a restart be required, all the necessary configuration files, images, user data, network
      connections, and other resources required for operation (including the necessary hardware)
      SHOULD already be available at the alternative site.
      For the uninterrupted operation of clusters, the control plane of Kubernetes, the infrastructure
      applications of the clusters, and the pods of the applications SHOULD be distributed across
      several fire zones based on the location data of the corresponding nodes so that the failure of a
      fire zone will not lead to the failure of an application.
    notes: >-
      TBD
    status: pending
    rules: []

  - id: APP.4.4.A20
    title: Encrypted Data Storage for Pods
    levels:
    - elevated
    description: >-
      The file systems containing the persistent data of the control plane (etcd in particular in this
      context) and the application services SHOULD be encrypted.
    notes: >-
      TBD
    status: pending
    rules: []

  - id: APP.4.4.A21
    title: Regular Restart of Pods
    levels:
    - elevated
    description: >-
      Pods SHOULD be stopped and restarted regularly if there is an increased risk of external
      interference and a very high need for protection. No pod SHOULD run for more than 24
      hours. The availability of the applications in a pod SHOULD be ensured.
    notes: >-
      TBD
    status: pending
    rules: []
